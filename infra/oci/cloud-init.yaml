#cloud-config
package_update: true

packages:
  - git
  - python3
  - python3-pip

write_files:
  - path: /etc/mark6-bot.env
    owner: root:root
    permissions: "0600"
    content: |
      # Set your Telegram token, then enable/start the service:
      #   sudo systemctl enable --now mark6-bot
      TELEGRAM_BOT_TOKEN=

  - path: /etc/systemd/system/mark6-bot.service
    owner: root:root
    permissions: "0644"
    content: |
      [Unit]
      Description=Mark6 Telegram Bot
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      User=opc
      Group=opc
      WorkingDirectory=${app_dir}
      EnvironmentFile=/etc/mark6-bot.env
      ExecStart=${app_dir}/.venv/bin/python ${app_dir}/telegram_bot.py
      Restart=on-failure
      RestartSec=3

      [Install]
      WantedBy=multi-user.target

runcmd:
  - |
      set -euo pipefail

      APP_DIR="${app_dir}"
      REPO_URL="${repo_url}"

      if ! id -u opc >/dev/null 2>&1; then
        echo "Expected user 'opc' not found; cloud-init bootstrap expects Oracle Linux default user." >&2
        exit 0
      fi

      mkdir -p "$(dirname "$APP_DIR")"
      chown -R opc:opc "$(dirname "$APP_DIR")"

      if [ -d "$APP_DIR/.git" ]; then
        runuser -l opc -c "cd \"$APP_DIR\" && git fetch --all --prune && git reset --hard origin/main"
      else
        runuser -l opc -c "git clone \"$REPO_URL\" \"$APP_DIR\""
      fi

      runuser -l opc -c "cd \"$APP_DIR\" && python3 -m venv .venv"
      runuser -l opc -c "cd \"$APP_DIR\" && . .venv/bin/activate && pip install -U pip && pip install -r requirements.txt"

      systemctl daemon-reload
      systemctl disable mark6-bot >/dev/null 2>&1 || true

